# Инструкция по тестированию функций работы с XLSX-таблицей

## Обзор

Этот документ содержит детальные инструкции для ручного тестирования функций работы с XLSX-таблицей, которые не могут быть полностью автоматизированы через юнит-тесты или требуют интерактивного взаимодействия с пользователем.

## Статус автоматизированного тестирования

### ✅ Полностью автоматизировано

Следующие функции покрыты автоматическими тестами:

1. **Чтение диапазона ячеек (getRange)** - `__tests__/lib/excel-tools.test.ts`
   - Чтение диапазонов из файла
   - Парсинг диапазонов с именами листов
   - Обработка пустых ячеек

2. **Запись в ячейку (updateCell)** - `__tests__/lib/excel-tools.test.ts`
   - Обновление значений ячеек
   - Создание новых ячеек
   - Работа с разными типами данных

3. **Подтверждение записи** - `__tests__/lib/excel-tools.test.ts`
   - Мокирование подтверждений
   - Проверка вызова callback'ов

4. **Визуализация таблицы в чате** - `__tests__/lib/excel-tools.test.ts`
   - Форматирование в markdown
   - Обработка заголовков и данных

5. **Открытие таблицы в модальном окне** - `__tests__/components/ExcelViewer.test.tsx`
   - Отображение данных
   - Выделение ячеек
   - Пагинация

6. **Работа с меншонами диапазонов** - `__tests__/components/ChatInterface.test.tsx`
   - Парсинг упоминаний
   - Отображение в сообщениях

### ⚠️ Требует ручного тестирования

Следующие функции требуют интерактивного тестирования:

## 1. Тестирование выделения диапазонов в модальном окне

### Цель
Проверить, что пользователь может выделить диапазон ячеек в модальном окне ExcelViewer.

### Шаги для тестирования

1. **Открыть приложение и загрузить Excel файл**
   ```
   - Запустить приложение: npm run dev
   - Открыть браузер: http://localhost:3000
   - Загрузить тестовый файл через API (интерфейс загрузки не реализован):
     
     **Через терминал (рекомендуется):**
     
     * Windows PowerShell:
       curl.exe -X POST http://localhost:3000/api/excel/upload -F "file=@test.xlsx"
     
     * Windows CMD:
       curl -X POST http://localhost:3000/api/excel/upload -F "file=@test.xlsx"
     
     * Linux/Mac:
       curl -X POST http://localhost:3000/api/excel/upload -F "file=@test.xlsx"
     
     Примечание: 
     * Если файл находится в директории проекта (где вы запускаете команду), 
       можно использовать просто имя файла: "file=@test.xlsx"
     * Если файл в другой директории, укажите полный путь: "file=@C:\path\to\test.xlsx"
     * Можно использовать любой Excel файл (.xlsx, .xls, .csv), например: "file=@people_data.xlsx"
     
     **Альтернативные способы:**
     * Использовать Postman/Insomnia для отправки POST запроса на /api/excel/upload
     * Использовать компонент ExcelUpload программно (он существует, но не интегрирован в UI)
   ```

2. **Открыть Excel файл в модальном окне**
   ```
   - Использовать команду в чате: "Покажи файл people_data.xlsx" или "Покажи файл test.xlsx"
   - AI должен найти файл по имени и открыть его в модальном окне ExcelViewer
   - Примечание: Список загруженных файлов не отображается в UI, 
     но можно получить список через API: GET /api/excel/list
   - Если AI не может найти файл, убедитесь, что файл был успешно загружен через API
   ```

3. **Выделить диапазон ячеек**
   ```
   - Кликнуть на первую ячейку диапазона (например, A1)
   - Удерживая Shift, кликнуть на последнюю ячейку (например, B5)
   - Или использовать перетаскивание мыши для выделения диапазона
   ```

4. **Проверить визуальное выделение**
   ```
   - Убедиться, что выделенные ячейки визуально выделены (например, синим цветом)
   - Проверить, что внизу модального окна отображается информация о выделенном диапазоне
   ```

5. **Проверить вставку упоминания в чат**
   ```
   - После выделения диапазона, должна появиться кнопка "Вставить в чат"
   - Кликнуть на кнопку
   - Проверить, что в поле ввода чата появилось упоминание (например, "@Sheet1!A1:B5")
   ```

### Ожидаемый результат
- Диапазон ячеек визуально выделяется
- Информация о диапазоне отображается корректно
- Упоминание диапазона вставляется в поле ввода чата

### Известные ограничения
- В текущей реализации ExcelViewer поддерживает только выделение одной ячейки
- Для выделения диапазонов требуется дополнительная реализация

---

## 2. Тестирование вставки упоминаний диапазонов в поле ввода

### Цель
Проверить, что упоминания диапазонов (@Sheet1!A1:B3) корректно вставляются в поле ввода чата.

### Шаги для тестирования

1. **Открыть чат интерфейс**
   ```
   - Убедиться, что чат открыт и готов к вводу
   ```

2. **Вставить упоминание диапазона вручную**
   ```
   - Ввести в поле ввода: "@Sheet1!A1:B3"
   - Проверить, что текст отображается корректно
   ```

3. **Вставить упоминание через UI**
   ```
   - Открыть Excel файл в модальном окне
   - Выделить диапазон ячеек
   - Кликнуть на кнопку "Вставить в чат"
   - Проверить, что упоминание появилось в поле ввода
   ```

4. **Проверить автодополнение (если реализовано)**
   ```
   - Начать вводить "@" в поле ввода
   - Проверить, появляется ли список доступных диапазонов
   - Выбрать диапазон из списка
   ```

5. **Отправить сообщение с упоминанием**
   ```
   - Ввести сообщение: "Покажи данные из @Sheet1!A1:B3"
   - Отправить сообщение
   - Проверить, что упоминание отображается в отправленном сообщении
   ```

### Ожидаемый результат
- Упоминания диапазонов корректно вставляются в поле ввода
- Упоминания отображаются в отправленных сообщениях
- Упоминания кликабельны и выделены визуально

---

## 3. Тестирование взаимодействия агента с диапазонами

### Цель
Проверить, что агент правильно интерпретирует упоминания диапазонов и выполняет операции с ними.

### Шаги для тестирования

1. **Отправить запрос с упоминанием диапазона**
   ```
   - Ввести в чат: "Покажи данные из @Sheet1!A1:B3"
   - Отправить сообщение
   ```

2. **Проверить ответ агента**
   ```
   - Агент должен распознать упоминание диапазона
   - Агент должен использовать инструмент getRange для чтения данных
   - Агент должен отобразить данные из диапазона в ответе
   ```

3. **Проверить операции с диапазонами**
   ```
   - Запрос: "Обнови ячейку A2 на значение 'test@example.com'"
   - Агент должен запросить подтверждение
   - После подтверждения агент должен обновить ячейку
   - Проверить, что ячейка действительно обновилась
   ```

4. **Проверить обработку ошибок**
   ```
   - Отправить запрос с несуществующим диапазоном: "@Sheet1!Z999:Z999"
   - Проверить, что агент корректно обрабатывает ошибку
   - Проверить, что пользователю показывается понятное сообщение об ошибке
   ```

5. **Проверить работу с несколькими диапазонами**
   ```
   - Отправить запрос: "Сравни @Sheet1!A1:B3 и @Sheet1!C1:D3"
   - Проверить, что агент обрабатывает оба диапазона
   - Проверить корректность сравнения
   ```

### Ожидаемый результат
- Агент корректно распознает упоминания диапазонов
- Агент использует правильные инструменты для работы с диапазонами
- Данные из диапазонов отображаются корректно
- Ошибки обрабатываются понятно для пользователя

---

## 4. Тестирование подтверждения записи в UI

### Цель
Проверить, что перед записью данных в таблицу появляется окно подтверждения.

### Шаги для тестирования

1. **Инициировать операцию записи**
   ```
   - Отправить в чат: "Обнови ячейку A2 на 'new-value@example.com'"
   ```

2. **Проверить появление диалога подтверждения**
   ```
   - Должно появиться модальное окно с подтверждением
   - Проверить заголовок диалога
   - Проверить текст сообщения
   - Проверить наличие кнопок "Подтвердить" и "Отмена"
   ```

3. **Проверить подтверждение**
   ```
   - Кликнуть на кнопку "Подтвердить"
   - Проверить, что ячейка обновилась
   - Проверить, что диалог закрылся
   ```

4. **Проверить отмену**
   ```
   - Повторить операцию записи
   - Кликнуть на кнопку "Отмена"
   - Проверить, что ячейка НЕ обновилась
   - Проверить, что диалог закрылся
   ```

5. **Проверить визуальное оформление диалога**
   ```
   - Для опасных операций (удаление, массовое обновление) диалог должен иметь тип "danger"
   - Проверить цветовую схему диалога
   - Проверить доступность (ARIA атрибуты)
   ```

### Ожидаемый результат
- Диалог подтверждения появляется перед записью
- Подтверждение работает корректно
- Отмена предотвращает запись
- Визуальное оформление соответствует типу операции

---

## 5. Тестирование отображения таблицы в чате

### Цель
Проверить, что данные из таблицы отображаются в чате в виде мини-превью.

### Шаги для тестирования

1. **Запросить отображение таблицы**
   ```
   - Отправить в чат: "Покажи таблицу из файла test.xlsx"
   ```

2. **Проверить форматирование таблицы**
   ```
   - Таблица должна отображаться в формате markdown
   - Проверить наличие заголовков
   - Проверить выравнивание столбцов
   - Проверить читаемость данных
   ```

3. **Проверить ограничение размера**
   ```
   - Для больших таблиц должно отображаться превью (первые N строк)
   - Должна быть ссылка "Показать полностью" или "Открыть в модальном окне"
   ```

4. **Проверить интерактивность**
   ```
   - Ячейки в превью должны быть кликабельны
   - Клик на ячейку должен открывать модальное окно с выделением этой ячейки
   ```

5. **Проверить работу с диапазонами**
   ```
   - Запросить: "Покажи диапазон A1:B5"
   - Проверить, что отображается только указанный диапазон
   - Проверить корректность данных
   ```

### Ожидаемый результат
- Таблица отображается в читаемом формате
- Превью ограничено разумным размером
- Ячейки интерактивны
- Диапазоны отображаются корректно

---

## 6. Тестирование работы с несколькими листами

### Цель
Проверить работу с файлами, содержащими несколько листов.

### Шаги для тестирования

1. **Загрузить файл с несколькими листами**
   ```
   - Создать или загрузить Excel файл с несколькими листами (Sheet1, Sheet2, Sheet3)
   - Загрузить файл в приложение
   ```

2. **Проверить указание листа в диапазоне**
   ```
   - Отправить: "Покажи @Sheet2!A1:B5"
   - Проверить, что данные берутся из правильного листа
   ```

3. **Проверить переключение листов в модальном окне**
   ```
   - Открыть файл в модальном окне
   - Проверить наличие вкладок или селектора листов
   - Переключиться на другой лист
   - Проверить, что данные обновились
   ```

4. **Проверить операции с разными листами**
   ```
   - Обновить ячейку в Sheet1: "Обнови @Sheet1!A1 на 'value1'"
   - Обновить ячейку в Sheet2: "Обнови @Sheet2!A1 на 'value2'"
   - Проверить, что оба обновления выполнены корректно
   ```

### Ожидаемый результат
- Поддерживается работа с несколькими листами
- Упоминания диапазонов корректно обрабатывают имена листов
- Переключение листов работает в UI

---

## 7. Тестирование производительности с большими файлами

### Цель
Проверить работу с большими Excel файлами (1000+ строк).

### Шаги для тестирования

1. **Загрузить большой файл**
   ```
   - Создать или загрузить Excel файл с 1000+ строками
   - Загрузить файл в приложение
   ```

2. **Проверить время загрузки**
   ```
   - Измерить время загрузки файла
   - Проверить, что загрузка не блокирует UI
   - Проверить наличие индикатора загрузки
   ```

3. **Проверить пагинацию**
   ```
   - Открыть файл в модальном окне
   - Проверить, что отображается только первая страница
   - Переключиться на следующую страницу
   - Проверить, что данные загружаются корректно
   ```

4. **Проверить операции с большими диапазонами**
   ```
   - Запросить диапазон из 100+ ячеек: "@Sheet1!A1:J100"
   - Проверить время обработки
   - Проверить отображение данных
   ```

5. **Проверить использование памяти**
   ```
   - Открыть DevTools → Memory
   - Выполнить несколько операций с большим файлом
   - Проверить, что нет утечек памяти
   ```

### Ожидаемый результат
- Большие файлы загружаются без блокировки UI
- Пагинация работает корректно
- Операции выполняются в разумное время
- Нет утечек памяти

---

## 8. Тестирование обработки ошибок

### Цель
Проверить корректную обработку различных ошибок.

### Шаги для тестирования

1. **Ошибка: файл не найден**
   ```
   - Запросить: "Покажи @NonExistentFile!A1:B5"
   - Проверить сообщение об ошибке
   ```

2. **Ошибка: лист не найден**
   ```
   - Запросить: "Покажи @Sheet999!A1:B5"
   - Проверить сообщение об ошибке
   ```

3. **Ошибка: неверный формат диапазона**
   ```
   - Запросить: "Покажи @InvalidRange"
   - Проверить сообщение об ошибке
   ```

4. **Ошибка: файл поврежден**
   ```
   - Загрузить поврежденный Excel файл
   - Попытаться открыть его
   - Проверить сообщение об ошибке
   ```

5. **Ошибка: нет прав на запись**
   ```
   - Попытаться обновить ячейку в файле только для чтения
   - Проверить сообщение об ошибке
   ```

### Ожидаемый результат
- Все ошибки обрабатываются корректно
- Пользователю показываются понятные сообщения
- Приложение не падает при ошибках

---

## 9. Тестирование доступности (Accessibility)

### Цель
Проверить доступность функций для пользователей с ограниченными возможностями.

### Шаги для тестирования

1. **Клавиатурная навигация**
   ```
   - Открыть Excel файл в модальном окне
   - Использовать только клавиатуру для навигации
   - Tab - переход между ячейками
   - Enter/Space - выделение ячейки
   - Escape - закрытие модального окна
   ```

2. **Screen reader**
   ```
   - Включить screen reader (NVDA, JAWS, VoiceOver)
   - Навигация по таблице
   - Проверить, что все элементы объявляются
   - Проверить контекстную информацию
   ```

3. **ARIA атрибуты**
   ```
   - Открыть DevTools → Elements
   - Проверить наличие ARIA атрибутов:
     * aria-label для кнопок
     * aria-selected для выделенных ячеек
     * role="table" для таблиц
     * aria-live для динамического контента
   ```

4. **Контрастность**
   ```
   - Проверить контрастность текста и фона
   - Использовать инструмент проверки контрастности
   - Убедиться, что контрастность соответствует WCAG AA
   ```

### Ожидаемый результат
- Все функции доступны с клавиатуры
- Screen reader корректно объявляет элементы
- ARIA атрибуты присутствуют и корректны
- Контрастность соответствует стандартам

---

## 10. Тестирование интеграции с AI агентом

### Цель
Проверить полную интеграцию всех функций с AI агентом.

### Шаги для тестирования

1. **Комплексный сценарий: чтение и отображение**
   ```
   - Загрузить файл с данными
   - Отправить: "Покажи первые 5 строк из файла test.xlsx"
   - Проверить, что агент:
     * Распознал запрос
     * Использовал getRange
     * Отобразил данные в таблице
   ```

2. **Комплексный сценарий: обновление с подтверждением**
   ```
   - Отправить: "Обнови email в строке 2 на 'new@example.com'"
   - Проверить, что агент:
     * Запросил подтверждение
     * После подтверждения обновил ячейку
     * Показал обновленные данные
   ```

3. **Комплексный сценарий: работа с диапазонами**
   ```
   - Отправить: "Покажи сумму значений из диапазона B2:B10"
   - Проверить, что агент:
     * Распознал диапазон
     * Прочитал данные
     * Вычислил сумму
     * Показал результат
   ```

4. **Комплексный сценарий: множественные операции**
   ```
   - Отправить: "Обнови все email в столбце A на домен @newdomain.com"
   - Проверить, что агент:
     * Запросил подтверждение (опасная операция)
     * После подтверждения обновил все ячейки
     * Показал результат
   ```

### Ожидаемый результат
- Агент корректно использует все инструменты
- Операции выполняются в правильном порядке
- Пользователь получает понятные ответы

---

## Чек-лист для полного тестирования

- [ ] Выделение диапазонов в модальном окне
- [ ] Вставка упоминаний в поле ввода
- [ ] Взаимодействие агента с диапазонами
- [ ] Подтверждение записи в UI
- [ ] Отображение таблицы в чате
- [ ] Работа с несколькими листами
- [ ] Производительность с большими файлами
- [ ] Обработка ошибок
- [ ] Доступность (Accessibility)
- [ ] Интеграция с AI агентом

---

## Запуск автоматических тестов

Перед ручным тестированием рекомендуется запустить автоматические тесты:

```bash
# Запустить все тесты
npm test

# Запустить только тесты для Excel функций
npm test -- excel-tools

# Запустить тесты с покрытием
npm run test:coverage

# Запустить E2E тесты
npm run test:e2e
```

---

## Отчет о тестировании

После выполнения ручного тестирования рекомендуется заполнить отчет:

1. **Дата тестирования**: ___________
2. **Версия приложения**: ___________
3. **Тестировщик**: ___________
4. **Результаты по каждому разделу**: ___________
5. **Найденные проблемы**: ___________
6. **Рекомендации**: ___________

---

## Контакты и поддержка

При обнаружении проблем или вопросов:
- Создать issue в репозитории проекта
- Обратиться к команде разработки
- Проверить документацию в `/docs`

