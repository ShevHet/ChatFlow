# Устранение проблем

Этот документ содержит решения для распространенных проблем при работе с проектом ChatFlow.

## Проблемы с npm install

### Предупреждения EPERM при установке зависимостей

**Симптомы:**
```
npm warn cleanup Failed to remove some directories
[Error: EPERM: operation not permitted, rmdir ...]
```

**Причина:**
Эта проблема часто возникает при работе с проектом в OneDrive или когда файлы заблокированы другими процессами.

**Решения:**

#### Вариант 1: Игнорировать предупреждения (рекомендуется)
Эти предупреждения не критичны и не влияют на работу проекта. Установка завершается успешно, несмотря на предупреждения.

#### Вариант 2: Очистка и переустановка
```bash
# Удалите node_modules и package-lock.json
rm -rf node_modules package-lock.json

# Или в Windows PowerShell:
Remove-Item -Recurse -Force node_modules, package-lock.json

# Переустановите зависимости
npm install
```

#### Вариант 3: Использование npm ci
```bash
# Удалите node_modules
rm -rf node_modules

# Используйте npm ci для чистой установки
npm ci
```

#### Вариант 4: Отключение синхронизации OneDrive для node_modules
1. Откройте настройки OneDrive
2. Добавьте `node_modules` в список исключений
3. Или переместите проект вне папки OneDrive

---

## Уязвимости безопасности

### Проверка уязвимостей

```bash
npm audit
```

### Исправление уязвимостей

#### Безопасное исправление (рекомендуется)
```bash
npm audit fix
```

Эта команда исправит только те уязвимости, которые не требуют изменений в зависимостях.

#### Принудительное исправление (осторожно!)
```bash
npm audit fix --force
```

**Внимание:** Эта команда может обновить зависимости до версий с breaking changes. Используйте только если понимаете последствия.

### Просмотр детальной информации

```bash
npm audit --json
```

---

## Проблемы с тестами

### Тесты не запускаются

**Симптомы:**
- Ошибки при запуске `npm test`
- Модули не найдены

**Решения:**

1. **Переустановите зависимости:**
```bash
rm -rf node_modules package-lock.json
npm install
```

2. **Очистите кэш Jest:**
```bash
npm test -- --clearCache
```

3. **Проверьте версию Node.js:**
```bash
node --version
# Должна быть версия 18 или выше
```

### E2E тесты не работают

**Симптомы:**
- Playwright не может запустить браузеры
- Ошибки подключения к серверу

**Решения:**

1. **Переустановите браузеры Playwright:**
```bash
npm run test:install-playwright
```

2. **Убедитесь, что сервер не запущен на порту 3000:**
```bash
# Windows PowerShell
Get-NetTCPConnection -LocalPort 3000

# Linux/macOS
lsof -i :3000
```

3. **Запустите тесты с проверкой сервера:**
```bash
npm run test:e2e:check
```

---

## Проблемы с базой данных

### Ошибки при работе с SQLite

**Симптомы:**
- `SQLITE_BUSY: database is locked`
- `SQLITE_CORRUPT: database disk image is malformed`

**Решения:**

1. **Проверьте, не открыта ли БД в другом процессе:**
   - Закройте все программы, которые могут использовать `chatflow.db`
   - Перезапустите приложение

2. **Создайте резервную копию и пересоздайте БД:**
```bash
# Создайте резервную копию
cp chatflow.db chatflow.db.backup

# Удалите поврежденную БД
rm chatflow.db

# Перезапустите приложение (БД создастся автоматически)
```

3. **Проверьте права доступа к файлу БД:**
```bash
# Убедитесь, что у приложения есть права на запись
chmod 644 chatflow.db
```

---

## Проблемы с миграциями БД

### Ошибки при применении миграций

**Симптомы:**
- `Migration X not found`
- `Failed to apply migration`

**Решения:**

1. **Проверьте формат файлов миграций:**
   - Имя файла должно быть: `{номер}_{название}.sql`
   - Файл должен содержать разделитель `-- DOWN MIGRATION`

2. **Проверьте статус миграций:**
```bash
# Через Node.js скрипт
node -e "const { getDatabase } = require('./lib/db'); const { MigrationManager } = require('./lib/migration-manager'); const db = getDatabase(); const mm = new MigrationManager(db); console.log(mm.getStatus());"
```

3. **Откатите проблемную миграцию:**
```bash
# Если есть скрипт для отката
npm run migrate:rollback
```

---

## Проблемы с OpenAI API

### Ошибки при обращении к API

**Симптомы:**
- `401 Unauthorized`
- `429 Rate limit exceeded`
- `500 Internal Server Error`

**Решения:**

1. **Проверьте API ключ:**
```bash
# Убедитесь, что ключ установлен в .env.local
cat .env.local | grep OPENAI_API_KEY
```

2. **Проверьте баланс аккаунта OpenAI:**
   - Зайдите на https://platform.openai.com
   - Проверьте баланс и лимиты

3. **Используйте retry механизм:**
   - Проект автоматически повторяет запросы при временных ошибках
   - Проверьте логи для деталей

### Ошибка "Country, region, or territory not supported" (403)

**Симптомы:**
```json
{
  "error": "Ваш регион не поддерживается OpenAI API. Разверните проект на сервере в поддерживаемом регионе.",
  "type": "EXTERNAL_API",
  "statusCode": 403,
  "code": "unsupported_country_region_territory"
}
```

**Возможные причины:**

1. **Разница между браузером и сервером:**
   - Если запросы работают в браузере (chat.openai.com), но не работают через приложение, это означает, что **IP сервера заблокирован**, а **IP клиента (браузера) разрешен**
   - Приложение делает запросы через серверный API route (`/api/chat`), поэтому OpenAI видит IP сервера, а не IP клиента
   - В браузере запросы идут напрямую с IP клиента, поэтому там работает

2. **Региональные ограничения OpenAI:**
   - OpenAI API недоступен в некоторых странах/регионах
   - Ограничения могут быть на уровне страны, провайдера или IP-адреса

2. **Проблемы с API ключом:**
   - Ключ может быть привязан к региону, который не поддерживается
   - Ключ может быть заблокирован или ограничен

3. **Проблемы с сетью/провайдером:**
   - Провайдер может блокировать доступ к OpenAI API
   - Корпоративная сеть может иметь ограничения

**Решения:**

1. **Проверка API ключа:**
   - Убедитесь, что ключ валиден на https://platform.openai.com
   - Проверьте, не заблокирован ли аккаунт
   - Создайте новый ключ, если текущий не работает

2. **Для production деплоя:**
   - Разверните приложение на сервере в поддерживаемом регионе (Vercel, AWS, GCP)
   - API запросы будут идти с сервера, а не с клиента
   - Это решает проблему региональных ограничений для пользователей

3. **Альтернативные провайдеры:**
   - Рассмотрите использование других AI-провайдеров (Anthropic, Google, локальные модели)
   - Проект можно адаптировать для работы с другими провайдерами

**Важно для деплоя:**

✅ **Можно выкладывать проект** - ошибка обрабатывается корректно, пользователь видит понятное сообщение.

✅ **Для production:** Разверните на сервере в поддерживаемом регионе (Vercel, AWS, GCP). Запросы к OpenAI будут идти с сервера, а не с клиента, что решает проблему для всех пользователей.

✅ **Обработка ошибок:** Проект корректно обрабатывает эту ошибку и показывает пользователю понятное сообщение вместо технической ошибки.

⚠️ **Для разработки:** Если вы находитесь в неподдерживаемом регионе, разверните проект на удаленном сервере в поддерживаемом регионе.

---

## Проблемы с доступностью

### ARIA атрибуты не работают

**Симптомы:**
- Скринридер не объявляет элементы
- Клавиатурная навигация не работает

**Решения:**

1. **Проверьте, что компоненты используют правильные ARIA атрибуты:**
   - Откройте DevTools
   - Проверьте элементы на наличие `role`, `aria-label`, `aria-live`

2. **Запустите тесты доступности:**
```bash
npm test -- __tests__/components/
```

3. **Используйте инструменты проверки доступности:**
   - Chrome DevTools Lighthouse
   - axe DevTools Extension

---

## Проблемы с производительностью

### Медленная работа приложения

**Решения:**

1. **Оптимизируйте работу с БД:**
   - Используйте индексы для частых запросов
   - Применяйте пагинацию для больших списков

2. **Проверьте размер node_modules:**
```bash
# Проверьте размер
du -sh node_modules

# Очистите неиспользуемые зависимости
npm prune
```

3. **Используйте production сборку:**
```bash
npm run build
npm start
```

---

## Проблемы с кодировкой (Windows)

### Кракозябры в консоли

**Симптомы:**
- Неправильное отображение русских символов
- Вопросительные знаки вместо букв

**Решения:**

1. **Измените кодировку консоли:**
```powershell
# В PowerShell
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
chcp 65001
```

2. **Используйте Windows Terminal вместо обычной консоли**

3. **Настройте кодировку в IDE:**
   - VS Code: File → Preferences → Settings → Files: Encoding → UTF-8

---

## Проблемы с Git

### Конфликты при синхронизации

**Решения:**

1. **Добавьте правильные файлы в .gitignore:**
```
node_modules/
chatflow.db
.env.local
coverage/
test-results/
playwright-report/
.DS_Store
```

2. **Не коммитьте временные файлы:**
```bash
# Проверьте статус перед коммитом
git status

# Добавьте только нужные файлы
git add .
```

---

## Получение помощи

Если проблема не решена:

1. **Проверьте логи:**
   - Консоль браузера (F12)
   - Логи сервера
   - Логи тестов

2. **Соберите информацию:**
   - Версия Node.js: `node --version`
   - Версия npm: `npm --version`
   - Операционная система
   - Текст ошибки

3. **Создайте issue:**
   - Опишите проблему подробно
   - Приложите логи и скриншоты
   - Укажите шаги для воспроизведения

---

## Полезные команды

```bash
# Полная очистка и переустановка
rm -rf node_modules package-lock.json .next
npm install

# Проверка всех зависимостей
npm outdated

# Обновление зависимостей (осторожно!)
npm update

# Проверка структуры проекта
npm run lint
npm test

# Полное тестирование
npm run test:all
```

---

**Последнее обновление:** 2024

