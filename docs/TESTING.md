# Инструкция по тестированию проекта ChatFlow

## Содержание
1. [Подготовка к тестированию](#подготовка-к-тестированию)
2. [Запуск автоматизированных тестов](#запуск-автоматизированных-тестов)
3. [Ручное тестирование (визуальная проверка)](#ручное-тестирование-визуальная-проверка)
4. [Чек-лист финальной проверки](#чек-лист-финальной-проверки)

---

## Подготовка к тестированию

### 1.1. Установка зависимостей

```bash
# Установка всех зависимостей проекта
bun install

# Установка браузеров для Playwright (если еще не установлены)
bun run test:install-playwright
```

### 1.2. Настройка окружения

1. **Создайте файл `.env.local`** в корне проекта:
   
   **Шаги:**
   - Откройте корневую папку проекта (где находится `package.json`)
   - Создайте новый файл с именем `.env.local` (точка в начале обязательна!)
   - Откройте файл в текстовом редакторе
   - Впишите следующую строку:
     ```
     OPENAI_API_KEY=your_openai_api_key_here
     ```
   - Замените `your_openai_api_key_here` на ваш реальный API ключ от OpenAI
   
   **Как получить API ключ OpenAI:**
   - Перейдите на https://platform.openai.com/api-keys
   - Войдите в свой аккаунт (или создайте новый)
   - Нажмите "Create new secret key"
   - Скопируйте ключ и вставьте в файл `.env.local`
   
   **Важно:**
   - Файл `.env.local` уже должен быть в `.gitignore` (не коммитится в репозиторий)
   - Не делитесь своим API ключом ни с кем
   - Если ключ скомпрометирован, удалите его и создайте новый
   
   **Пример содержимого файла `.env.local`:**
   ```
   OPENAI_API_KEY=sk-proj-abc123def456ghi789jkl012mno345pqr678stu901vwx234yz
   ```

2. **Проверьте наличие файла `example.xlsx`** в корне проекта (создается автоматически при первом обращении)
   
   **Шаги:**
   - Файл создается автоматически при первом запросе к Excel API
   - Если файла нет, он будет создан при первом запуске приложения и обращении к `/api/excel`
   - Можно также создать вручную через скрипт `scripts/create-example-xlsx.js` (если есть)

3. **Убедитесь, что база данных инициализирована** (создается автоматически при первом запуске)
   
   **Шаги:**
   - База данных `db.sqlite` или `chatflow.db` создается автоматически
   - При первом запуске приложения выполняется миграция через `lib/migrate.ts`
   - Если базы нет, она будет создана при первом обращении к API
   
   **Важно:** Файл `db.sqlite` может не существовать до первого обращения к API или до ручной инициализации. Это нормально!
   
   **Как инициализировать базу данных:**
   
   **Способ 1: Автоматическая инициализация (рекомендуется)**
   ```bash
   # Запустите скрипт инициализации
   bun run init-db
   # или напрямую:
   bun run scripts/init-db.ts
   ```
   Скрипт создаст файл `db.sqlite`, создаст все необходимые таблицы и выведет информацию о структуре БД.
   
   **Способ 2: Инициализация через API**
   ```bash
   # Запустите приложение
   bun run dev
   
   # В другом терминале или браузере выполните запрос:
   curl http://localhost:3000/api/threads
   # или откройте в браузере: http://localhost:3000/api/threads
   ```
   База данных будет создана автоматически при первом обращении к API.
   
   **Как проверить инициализацию:**
   
   **Способ 1: Проверка наличия файла БД**
   ```bash
   # Проверьте наличие файла в корне проекта
   ls db.sqlite
   # или на Windows:
   dir db.sqlite
   # или в PowerShell:
   Test-Path db.sqlite
   ```
   Если файл существует, база данных создана.
   
   **Способ 2: Проверка структуры таблиц через Bun REPL**
   ```bash
   # Запустите Bun REPL
   bun
   
   # В REPL выполните:
   const { getDatabase } = require('./lib/db');
   const db = getDatabase();
   
   # Проверьте наличие таблиц
   const tables = db.query("SELECT name FROM sqlite_master WHERE type='table'").all();
   console.log(tables);
   # Должны увидеть: [{ name: 'threads' }, { name: 'messages' }]
   
   # Проверьте структуру таблицы threads
   const threadsSchema = db.query("PRAGMA table_info(threads)").all();
   console.log(threadsSchema);
   
   # Проверьте структуру таблицы messages
   const messagesSchema = db.query("PRAGMA table_info(messages)").all();
   console.log(messagesSchema);
   ```
   
   **Способ 3: Проверка через API запрос**
   ```bash
   # Убедитесь, что приложение запущено (bun run dev)
   # Затем выполните запрос к API:
   curl http://localhost:3000/api/threads
   # или откройте в браузере: http://localhost:3000/api/threads
   ```
   Если запрос возвращает пустой массив `[]` или список тредов (без ошибок), база данных инициализирована корректно.
   
   **Способ 4: Проверка через тесты**
   ```bash
   # Запустите тесты базы данных
   bun test __tests__/lib/db.test.ts
   ```
   Если тесты проходят, база данных работает корректно.
   
   **Способ 5: Использование скрипта инициализации**
   ```bash
   # Запустите скрипт инициализации (он также проверяет структуру)
   bun run init-db
   ```
   Скрипт `scripts/init-db.ts` создаст БД (если её нет) и выведет полную информацию о структуре таблиц и количестве записей.

### 1.3. Запуск приложения (для E2E тестов)

```bash
# Запуск в режиме разработки
bun run dev
```

Приложение должно быть доступно по адресу: `http://localhost:3000`

---

## Запуск автоматизированных тестов

### 2.1. Все тесты

```bash
# Запуск всех unit и интеграционных тестов с покрытием + E2E тесты
bun run test:all

# Или по отдельности:
bun run test:coverage  # Unit и интеграционные тесты с покрытием
bun run test:e2e       # E2E тесты
```

### 2.2. Категории тестов

#### Unit тесты компонентов
```bash
bun run test:unit
# или конкретный компонент:
bun test __tests__/components/ThreadList.test.tsx
bun test __tests__/components/ConfirmationDialog.test.tsx
bun test __tests__/components/ExcelViewer.test.tsx
bun test __tests__/components/ChatInterface.test.tsx
```

#### Интеграционные тесты API
```bash
bun run test:api
# или конкретный API:
bun test __tests__/api/threads.test.ts
bun test __tests__/api/messages.test.ts
bun test __tests__/api/chat.test.ts
bun test __tests__/api/ai-chat.test.ts
bun test __tests__/api/excel.test.ts
bun test __tests__/api/excel-calculate.test.ts
```

#### Тесты библиотек
```bash
bun test __tests__/lib/db.test.ts
bun test __tests__/lib/excel-service.test.ts
bun test __tests__/lib/excel-utils.test.ts
```

#### Тесты производительности
```bash
bun test __tests__/performance/api-performance.test.ts
```

#### Тесты безопасности
```bash
bun test __tests__/security/security.test.ts
```

#### E2E тесты
```bash
# Все E2E тесты
bun run test:e2e

# Конкретные E2E тесты
bun test e2e/app.spec.ts
bun test e2e/excel-workflow.spec.ts
bun test e2e/messages-history.spec.ts

# E2E тесты с UI режимом (интерактивный)
bun run test:e2e:ui
```

### 2.3. Просмотр покрытия кода

```bash
# Генерация отчета о покрытии
bun run test:coverage

# Откройте отчет в браузере:
# coverage/lcov-report/index.html
```

**Целевые значения покрытия:**
- Branches: минимум 20%
- Functions: минимум 25%
- Lines: минимум 30%
- Statements: минимум 30%

### 2.4. Режим наблюдения (watch mode)

```bash
# Автоматический перезапуск тестов при изменении файлов
bun run test:watch
```

### 2.5. Что покрыто автоматизированными тестами

✅ **API эндпоинты:**
- GET/POST /api/threads (создание, получение, валидация)
- GET/POST /api/messages (создание, получение, валидация)
- GET/POST /api/chat (сохранение сообщений)
- POST /api/ai-chat (валидация входных данных)
- GET/POST /api/excel (чтение и запись Excel)
- POST /api/excel/calculate (вычисления: sum, average, min, max)

✅ **Компоненты:**
- ThreadList (отображение, выбор, клавиатурная навигация)
- ConfirmationDialog (открытие/закрытие, кнопки, Escape)
- ExcelViewer (загрузка данных, отображение, закрытие)
- ChatInterface (базовый рендеринг, загрузка сообщений)

✅ **Библиотеки:**
- db.ts (работа с базой данных)
- excel-service.ts (чтение, запись, вычисления)
- excel-utils.ts (парсинг диапазонов, валидация)

✅ **E2E сценарии:**
- Создание тредов
- Отправка сообщений
- Переключение между тредами
- История сообщений
- Работа с Excel через AI

✅ **Безопасность:**
- Защита от SQL Injection
- Валидация входных данных
- Обработка XSS

✅ **Производительность:**
- Время ответа API
- Обработка больших объемов данных

---

## Ручное тестирование (визуальная проверка)

Автоматизированные тесты покрывают функциональность, но некоторые аспекты требуют визуальной проверки.

### 3.1. Визуальная проверка UI

1. **Откройте приложение:** `http://localhost:3000`

2. **Проверьте визуальное оформление:**
   - ✅ Левая панель с тредами отображается корректно
   - ✅ Кнопка "Новый тред" видна и стилизована правильно
   - ✅ Активный тред выделен синим цветом с левой границей
   - ✅ Сообщения пользователя выровнены справа, синий фон
   - ✅ Сообщения ассистента выровнены слева, серый фон
   - ✅ Модальные окна (ConfirmationDialog, ExcelViewer) отображаются поверх контента
   - ✅ Индикатор загрузки (три точки) анимируется плавно

3. **Проверьте адаптивность:**
   - ✅ Интерфейс корректно отображается на разных размерах окна
   - ✅ Элементы не перекрываются
   - ✅ Текст читаем на всех размерах

### 3.2. Проверка работы AI (требует реального API ключа)

1. **Отправьте сообщение в чат**
2. **Проверьте:**
   - ✅ Ответ стримится постепенно (не появляется сразу весь)
   - ✅ Индикатор загрузки работает во время генерации
   - ✅ Ответ релевантен запросу
   - ✅ AI может использовать tools (getRange, updateCell, etc.)

### 3.3. Проверка Excel функциональности через UI

1. **Отправьте запрос:** "Прочитай диапазон Sheet1!A1:D5"
2. **Проверьте:**
   - ✅ Таблица отображается в ответе
   - ✅ Данные корректны
   - ✅ Упоминания диапазонов кликабельны (синие, подчеркнутые)
   - ✅ При клике на упоминание открывается ExcelViewer

3. **Отправьте запрос:** "Обнови ячейку A1 на 'Тест'"
4. **Проверьте:**
   - ✅ Появляется диалог подтверждения
   - ✅ Вопрос понятен
   - ✅ После подтверждения ячейка обновляется

### 3.4. Проверка на разных браузерах

Протестируйте вручную в:
- Chrome/Edge (Chromium)
- Firefox
- Safari (если доступен)

---

## Чек-лист финальной проверки

### Функциональность
- [ ] Все автоматизированные тесты проходят (`bun run test:all`)
- [ ] Покрытие кода соответствует требованиям (минимум 20-30%)
- [ ] Приложение запускается без ошибок
- [ ] База данных создается и работает корректно
- [ ] Excel файлы читаются и записываются

### UI/UX
- [ ] Интерфейс отображается корректно
- [ ] Все элементы видимы и доступны
- [ ] Анимации плавные
- [ ] Адаптивность работает на разных размерах экрана

### Производительность
- [ ] Страница загружается быстро (< 2 секунд)
- [ ] API отвечает в разумное время (< 1 секунды для большинства запросов)
- [ ] Нет утечек памяти (проверьте через DevTools Memory)

### Безопасность
- [ ] Все тесты безопасности проходят
- [ ] SQL Injection защита работает
- [ ] Валидация входных данных на всех уровнях

### Документация
- [ ] README актуален
- [ ] API документация полная
- [ ] Комментарии в коде присутствуют

---

## Быстрая справка по командам

```bash
# Все тесты с покрытием
bun run test:coverage

# Только unit тесты
bun run test:unit

# Только API тесты
bun run test:api

# Только E2E тесты
bun run test:e2e

# Все тесты (unit + E2E)
bun run test:all

# Тесты в режиме наблюдения
bun run test:watch

# Установка браузеров для Playwright
bun run test:install-playwright
```

---

## Примечания

- **Автоматизированные тесты** покрывают большую часть функциональности проекта
- **Ручное тестирование** необходимо только для визуальной проверки и проверки работы с реальным AI API
- **E2E тесты** требуют запущенного приложения (`bun run dev`)
- **Тесты безопасности** проверяют защиту от основных уязвимостей
- **Тесты производительности** помогают выявить проблемы с производительностью на раннем этапе

---

## Решение проблем

### Тесты не запускаются
1. Убедитесь, что зависимости установлены: `bun install`
2. Проверьте, что Node.js версии 18+
3. Для E2E тестов установите браузеры: `bun run test:install-playwright`

### E2E тесты падают
1. Убедитесь, что приложение запущено: `bun run dev`
2. Проверьте, что сервер доступен на `http://localhost:3000`
3. Увеличьте timeout в тестах, если нужно

### Низкое покрытие кода
1. Запустите `bun run test:coverage`
2. Откройте `coverage/lcov-report/index.html`
3. Найдите непокрытые файлы и добавьте тесты

---

**Все автоматизированные тесты находятся в папках:**
- `__tests__/` - unit и интеграционные тесты
- `e2e/` - end-to-end тесты
