# ChatFlow

Приложение чата с поддержкой тредов, построенное на Next.js 16, TypeScript и SQLite.

## Технологии

- **Next.js 16** - React фреймворк
- **TypeScript** - Типизация
- **SQLite (better-sqlite3)** - База данных
- **Tailwind CSS** - Стилизация
- **Bun** - Пакетный менеджер и runtimeс
- **Vercel AI SDK** - Интеграция с AI моделями и стриминг
- **Zod** - Валидация схем для tools

## Установка

1. **Инициализация проекта:**
   ```bash
   bun init
   ```

2. **Установите зависимости:**
   ```bash
   bun add next react react-dom typescript @tailwindcss/forms ai @ai-sdk/openai zod
   ```

3. **Создайте файл `.env.local`** в корне проекта и добавьте ваш OpenAI API ключ (если требуется):
   ```
   OPENAI_API_KEY=your_openai_api_key_here
   ```

4. **Запустите проект в режиме разработки:**
   ```bash
   bun run dev
   ```

5. Откройте [http://localhost:3000](http://localhost:3000) в браузере.

**Примечание:** Проект использует `better-sqlite3` для работы с SQLite. База данных `db.sqlite` будет создана автоматически при первом запуске через миграции.

## Структура проекта

```
ChatFlow/
├── app/
│   ├── api/
│   │   ├── ai-chat/              # API для AI чата со стримингом
│   │   ├── chat/                 # API для сохранения сообщений
│   │   ├── threads/              # API для управления тредами
│   │   ├── messages/             # API для управления сообщениями
│   │   └── excel/                # API для работы с Excel
│   │       └── calculate/        # API для вычислений в Excel
│   ├── layout.tsx                # Корневой layout
│   ├── page.tsx                  # Главная страница
│   └── globals.css               # Глобальные стили
├── components/
│   ├── ChatInterface.tsx         # Компонент чата
│   ├── ThreadList.tsx            # Список тредов
│   ├── ConfirmationDialog.tsx    # Модальное окно подтверждения
│   └── ExcelViewer.tsx           # Просмотр Excel данных
├── lib/
│   ├── db.ts                     # Работа с базой данных
│   ├── migrate.ts                # Миграции БД
│   ├── excel-service.ts          # Сервис для работы с Excel
│   ├── excel-utils.ts            # Утилиты для Excel
│   └── types.ts                  # TypeScript типы
├── __tests__/                    # Тесты
│   ├── lib/                      # Юнит-тесты
│   └── api/                      # Интеграционные тесты
├── docs/                         # Документация
│   ├── API.md                    # API документация
│   └── COMPONENTS.md             # Документация компонентов
└── package.json
```

## Функциональность

- ✅ Создание и управление тредами
- ✅ Отправка сообщений в чат
- ✅ Интеграция с AI моделями через Vercel AI SDK (useChat)
- ✅ Стриминг ответов от AI в реальном времени
- ✅ Сохранение истории сообщений в SQLite
- ✅ Загрузка истории при переключении тредов
- ✅ Client-side tools для подтверждения действий (Generative UI)
- ✅ Модальные окна с кнопками "Да"/"Нет" для опасных операций
- ✅ Работа с Excel таблицами через tools
- ✅ Чтение и запись данных в Excel файлы
- ✅ Вычисления в Excel (сумма, среднее, минимум, максимум)
- ✅ Архитектура по принципам SOLID
- ✅ Полное покрытие тестами (юнит, интеграционные, E2E)

## Настройка AI модели

По умолчанию используется `gpt-3.5-turbo`. Для использования других моделей или настройки API ключей, отредактируйте `app/api/chat/route.ts`.

Для работы с OpenAI необходимо установить переменную окружения:
```bash
OPENAI_API_KEY=your_api_key_here
```

## Требования

- Node.js 18+ 
- npm, pnpm или yarn
- OpenAI API ключ (для работы с AI моделями)

## Тестирование

Проект включает полную систему тестирования:

- **Unit-тесты** (Jest + React Testing Library) - для компонентов и утилит
- **Интеграционные тесты** (Jest) - для API роутов и работы с БД
- **E2E тесты** (Playwright) - для проверки всей функциональности

### Быстрый старт

```bash
# Установите зависимости (включая тестовые)
bun install

# Установите браузеры для Playwright
bun run test:install-playwright

# Запустите все тесты
bun run test:all
```

### Доступные команды

```bash
# Все unit и интеграционные тесты
bun test

# С покрытием кода
bun run test:coverage

# Только E2E тесты
bun run test:e2e

# Все тесты (unit + E2E)
bun run test:all
```

## Документация

Подробная документация доступна в папке `docs/`:

- [API Документация](docs/API.md) - описание всех API эндпоинтов
- [Документация компонентов](docs/COMPONENTS.md) - описание React компонентов и архитектуры

## Архитектура

Проект построен по принципам SOLID и чистой архитектуры:

- **Разделение на слои**: UI, API, Service, Data
- **Инкапсуляция**: бизнес-логика в сервисных слоях
- **Разделение ответственности**: каждый модуль имеет одну задачу
- **Расширяемость**: легко добавлять новые функции и tools

